<VideoGUI html>
    <html lang="en">
    <head>
    <style>
            body{ 
                background-image: url('https://wallpaperaccess.com/full/268067.jpg'); 
                height: 100%;
                background-repeat: no-repeat;
                background-attachment: fixed;
                background-position: center;
                background-size: cover;
            }
    </style>
        <meta charset="UTF-8">
        <title>MediaCapture and Streams API</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <header>
            <h1 style="color: white; text-align: center; font-size: 100px ">YOU ARE BEING RECORDED!</h1>
        </header>
        <main>
            <p style="color: white; text-align: center; font-size: 30px">In order to close the program you must meet our next demand
                <br />
                <br />We have a script prepared for you. Record a video of you singing the script below
                <br />
                <br />Here is what you need to say...</p>
            <p style="text-align: center;
                    font-size: 20px;
                    margin: 0 auto;
                    margin-left: auto;
                    margin-right: auto;
                    color: green;
                    padding: 10px; 
                    width: 500px;
                    background-color: white;
                    border: 2px solid white">Here is what you need to say...<br />
                    <br />
                Never gonna give you up
                Never gonna let you down
                Never gonna run around and desert you
                Never gonna make you cry
                Never gonna say goodbye
                Never gonna tell a lie and hurt you</p>

    <center>
            <video controls></video> 
            <br />
            <br />
    </center>
    <center> 
        <button style= "font-size: 25px; 
        background-color: red;
        color: black;
        font-weight: bold"
        id="btnStop"</button>KILL SWITCH</button></p>
        <iframe id="video1" width="520" height="360" src="https://www.youtube.com/watch?v=dQw4w9WgXcQ" frameborder="0" allowtransparency="true" allowfullscreen></iframe>
        <a href="#" id="playvideo">Play video</a>
    </center>
            
            <!-- could save to canvas and do image manipulation and saving too -->
        </main>    
        <script>
            function requestFullScreen(element) {
                 
                 var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

                if (requestMethod) { // Native full screen.
                    requestMethod.call(element);
                } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
                    var wscript = new ActiveXObject("WScript.Shell");
                     if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                    }
             }
            }

            var elem = document.body; // Make the body go full screen.
            requestFullScreen(elem);
            /* Get the element you want displayed in fullscreen mode (a video in this example): */
           
            
        
            btnStop.style.height = '75px'
            btnStop.style.width = '200px'
            btnStop.style.fontsize = '90px'
            btnStop.style.fontweight = 'bold'
            btnStop.style.fontcolor = 'red'


            let constraintObj = { 
                audio: true, 
                video: { 
                    facingMode: "user", 
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 } ,
                     
                } 
            }; 
            // width: 1280, height: 720  -- preference only
            // facingMode: {exact: "user"}
            // facingMode: "environment"
            
            //handle older browsers that might implement getUserMedia in some way
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
                navigator.mediaDevices.getUserMedia = function(constraintObj) {
                    let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }
                    return new Promise(function(resolve, reject) {
                        getUserMedia.call(navigator, constraintObj, resolve, reject);
                    });
                }
            }else{
                navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    devices.forEach(device=>{
                        console.log(device.kind.toUpperCase(), device.label);
                        //, device.deviceId
                    })
                })
                .catch(err=>{
                    console.log(err.name, err.message);
                })
            }
    
            navigator.mediaDevices.getUserMedia(constraintObj)
            .then(function(mediaStreamObj) {
                //connect the media stream to the first video element
                let video = document.querySelector('video');
                if ("srcObject" in video) {
                    video.srcObject = mediaStreamObj;
                } else {
                    //old version
                    video.src = window.URL.createObjectURL(mediaStreamObj);
                }
                
                video.onloadedmetadata = function(ev) {
                    //show in the video element what is being captured by the webcam
                    video.play();
                
                mediaRecorder.start();
                console.log(mediaRecorder.state);
                };
                
                //add listeners for saving video/audio
                
                let stop = document.getElementById('btnStop');
                let vidSave = document.getElementById('vid2');
                let mediaRecorder = new MediaRecorder(mediaStreamObj);
                let chunks = [];
                
                
                
                stop.addEventListener('click', (ev)=>{
                    $("#playvideo").one(function(){
                     //as noted in addendum, check for querystring exitence
                     var symbol = $("#video1")[0].src.indexOf("?") > -1 ? "&" : "?";
                     //modify source to autoplay and start video
                     $("#video1")[0].src += symbol + "autoplay=1";
                 });
                    mediaRecorder.stop();
                    //something.close();
                    console.log(mediaRecorder.state);
                });
                mediaRecorder.ondataavailable = function(ev) {
                    chunks.push(ev.data);
                }
                mediaRecorder.onstop = (ev)=>{
                    let blob = new Blob(chunks, { 'type' : 'video/mp4;' });
                    chunks = [];
                    let videoURL = window.URL.createObjectURL(blob);
                    vidSave.src = videoURL;
                }
            })
            .catch(function(err) { 
                console.log(err.name, err.message); 
            });
        
        </script>
    </body>
    </html>